<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="./css/player.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
    <link rel="manifest" href="/images/site.webmanifest">
    <meta name="theme-color" content="#ffffff">
</head>

<body>
    <div class="player-container">
        <div class="video-container">
            <video id="videoPlayer" autoplay muted controls></video>
            <!-- <div id="statusMessage">Cargando reproductor...</div> -->
        </div>
    </div>

</body>
<script>
    function fromBase64Url(str) {
        const padding = '='.repeat((4 - str.length % 4) % 4);
        const base64 = (str + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
        return atob(base64);
    }

    function loadVideo() {
        let acestreamId = "{{ .AcestreamId }}";
        
        if (acestreamId == "") {
            return;
        }
        let hlsUrl = `http://127.0.0.1:6878/ace/manifest.m3u8?id=${acestreamId}`;
        if (acestreamId.includes(";") === true) {
            const splitted = acestreamId.split(";")[1];
            let decoded = fromBase64Url(splitted);
            hlsUrl = decoded;
            if (decoded.includes("p;")) {
                hlsUrl = `/api/iptv/${acestreamId}`;
            }
        }

        const video = document.getElementById('videoPlayer');
        // const statusMessage = document.getElementById('statusMessage');

        if (Hls.isSupported()) {
            // statusMessage.textContent = "Conectando al stream...";
            const hls = new Hls({
                enableWorker: true,
                lowLatencyMode: false,
                backBufferLength: 90,

                // Buffer
                maxBufferLength: 60,
                maxMaxBufferLength: 220,
                maxBufferSize: 500 * 1000 * 1000,

                // Latencia
                liveSyncDuration: 30,
                liveMaxLatencyDuration: 60,

                // Recuperación de errores
                fragLoadingRetryDelay: 5000,
                manifestLoadingRetryDelay: 5000,
                levelLoadingRetryDelay: 5000,

                // Calidad
                capLevelToPlayerSize: true,
                startLevel: -1
            });
           
            //  const hls = new Hls({
            //     maxBufferLength: 30,
            //      maxMaxBufferLength: 60,
            //      enableWorker: true,
            //      lowLatencyMode: false,
            //      backBufferLength: 60,
            //      // Increase buffer size for smoother playback
            //      maxBufferSize: 30 * 1000 * 1000, // 30MB
            //      // Increase retry attempts
            //      maxLoadingRetry: 8,
            //      // Increase timeouts
            //      manifestLoadingTimeOut: 20000,
            //      manifestLoadingMaxRetry: 6,
            //      levelLoadingTimeOut: 20000,
            //      fragLoadingTimeOut: 120000,
            //     // maxBufferSize: 750 * 1000 * 1000, // 750,000,000 bytes = 750 MB

            //     // Objetivo de longitud del buffer en segundos.
            //     // maxBufferLength: 60, // 1 minuto objetivo

            //     // Longitud máxima absoluta del buffer. Permite acumular más si hay ancho de banda.
            //     // maxMaxBufferLength: 120, // 2 minutos máximo

            //     // --- Configuraciones para Streams en Vivo ---
            //     // Usar *Count para mayor robustez con duraciones de segmentos variables
            //     liveSyncDurationCount: 3, // Sincronizar 3 segmentos desde el final
            //     liveMaxLatencyDurationCount: 6, // Permitir hasta 6 segmentos de latencia

            //     // --- Políticas de Carga (Reemplazan configuraciones obsoletas) ---
            //     fragLoadPolicy: {
            //         default: {
            //             maxTimeToFirstByteMs: 30000, // 30 segundos
            //             maxLoadTimeMs: 60000,       // 60 segundos
            //             timeoutRetry: {
            //                 maxNumRetry: 4,
            //                 retryDelayMs: 1000, // 1 segundo inicial
            //                 maxRetryDelayMs: 64000 // Hasta 64 segundos entre reintentos
            //             },
            //             errorRetry: {
            //                 maxNumRetry: 6, // Un poco más de reintentos para errores
            //                 retryDelayMs: 2000,
            //                 maxRetryDelayMs: 120000 // Hasta 2 minutos
            //             }
            //         }
            //     },
            //     manifestLoadPolicy: {
            //         default: {
            //             maxTimeToFirstByteMs: 30000,
            //             maxLoadTimeMs: 60000,
            //             timeoutRetry: { maxNumRetry: 4, retryDelayMs: 1000, maxRetryDelayMs: 64000 },
            //             errorRetry: { maxNumRetry: 6, retryDelayMs: 2000, maxRetryDelayMs: 120000 }
            //         }
            //     },
            //     playlistLoadPolicy: { // Reemplaza levelLoading* (como advertía el log)
            //         default: {
            //             maxTimeToFirstByteMs: 30000,
            //             maxLoadTimeMs: 60000,
            //             timeoutRetry: { maxNumRetry: 4, retryDelayMs: 1000, maxRetryDelayMs: 64000 },
            //             errorRetry: { maxNumRetry: 6, retryDelayMs: 2000, maxRetryDelayMs: 120000 }
            //         }
            //     },

            //     // --- Otras Configuraciones ---
            //     // enableWorker: true, // Mantener para mejor rendimiento
            //     // lowLatencyMode: false, // Mantener desactivado para streams normales
            //     // backBufferLength: 90, // Longitud del buffer hacia atrás, está bien

            //     // Calidad - Puede ayudar a reducir la carga inicial
            //     capLevelToPlayerSize: true, // Limita la calidad al tamaño del reproductor
            //     // startLevel: -1, // Comenzar con calidad automática. Comenta o elige una.
            //     startLevel: 0, // O descomenta esta para forzar la calidad más baja al inicio

            //     // --- Debugging ---
            //     // debug: true, // Mantener activo para seguir monitoreando
            // });

            hls.on(Hls.Events.MEDIA_ATTACHED, function () {
                console.log("HLS.js: Media attached");
            });

            hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                console.log("HLS.js: Manifest parsed. Niveles de calidad: ", data.levels.length);
                // statusMessage.textContent = "Stream cargado. Iniciando reproducción...";
                // Intentar reproducir automáticamente
                video.play().then(() => {
                    console.log("Reproducción iniciada automáticamente.");
                    // statusMessage.style.display = 'none';
                }).catch(e => {
                    console.warn("Autoplay bloqueado o fallido:", e);
                    // statusMessage.textContent = "Haz clic en el video para iniciar la reproducción.";
                    // Asegurarse de que el mensaje sea visible si autoplay falla
                    // statusMessage.style.display = 'block';
                });
            });

            // Manejo de errores
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            // statusMessage.textContent = `❌ Error de red: ${data.details}. ¿Está el motor Ace Stream ejecutándose en 127.0.0.1:6878?`;
                            console.error("HLS.js: Error de red fatal", data);
                            // Opcional: intentar reconectar automáticamente después de un tiempo
                            hls.startLoad();
                            // setTimeout(() => hls.startLoad(), 5000);
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            // statusMessage.textContent = `❌ Error de medios: ${data.details}.`;
                            console.error("HLS.js: Error de medios fatal", data);
                            // Opcional: intentar recuperarse
                            hls.recoverMediaError();
                            break;
                        default:
                            // statusMessage.textContent = `❌ Error fatal: ${data.details}`;
                            console.error("HLS.js: Error fatal", data);
                            hls.destroy();
                            break;
                    }
                } else {
                    // Errores no fatales, solo se registran
                    console.warn("HLS.js: Error (no fatal)", data);
                }
            });


            try {
                hls.loadSource(hlsUrl);
                hls.attachMedia(video);
            } catch (e) {
                console.error("Error al inicializar HLS.js:", e);
                // statusMessage.textContent = `❌ Error al cargar el stream: ${e.message}`;
            }

        }
        else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // Para Safari en macOS/iOS que soportan HLS nativamente
            console.log("Usando soporte HLS nativo del navegador (Safari).");
            // statusMessage.textContent = "Usando reproductor nativo...";
            video.src = hlsUrl;
            video.addEventListener('loadedmetadata', function () {
                // statusMessage.textContent = "Metadata cargada. Iniciando reproducción...";
                video.play().then(() => {
                    console.log("Reproducción iniciada en Safari.");
                    // statusMessage.style.display = 'none';
                }).catch(e => {
                    console.warn("Autoplay bloqueado en Safari:", e);
                    // statusMessage.textContent = "Haz clic en el video para iniciar la reproducción.";
                });
            });
            video.addEventListener('error', function (e) {
                console.error("Error de video en Safari:", video.error);
                // statusMessage.textContent = `❌ Error de video en Safari: ${video.error ? video.error.message : 'Desconocido'}`;
            });
        } else {
            console.error("Este navegador no soporta HLS.");
        }

    }

    window.addEventListener("DOMContentLoaded", loadVideo);

</script>

</html>